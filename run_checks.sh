#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ (–∞–Ω–∞–ª–æ–≥ GitHub Actions)
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —É—Å–ø–µ—Ö–∞
success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏
error() {
    echo -e "${RED}‚úó $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Python
if ! command -v python &> /dev/null; then
    error "Python –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.9+"
    exit 1
fi

success "Python –Ω–∞–π–¥–µ–Ω: $(python --version)"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [[ -z "${VIRTUAL_ENV}" ]]; then
    warning "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"
    echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å venv:"
    echo "  python -m venv venv"
    echo "  source venv/bin/activate  # Linux/Mac"
    echo "  venv\\Scripts\\activate     # Windows"
    echo ""
else
    success "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ: $VIRTUAL_ENV"
    echo ""
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install -q -r requirements.txt
success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 1. Flake8 - –õ–∏–Ω—Ç–∏–Ω–≥
echo "üîç –ó–∞–ø—É—Å–∫ flake8 (–ª–∏–Ω—Ç–∏–Ω–≥)..."
if flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics; then
    success "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    error "–ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞!"
    exit 1
fi

if flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics > /tmp/flake8_report.txt; then
    WARNINGS=$(cat /tmp/flake8_report.txt | tail -1)
    if [[ "$WARNINGS" == *"0"* ]]; then
        success "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    else
        warning "–ù–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: $WARNINGS"
        echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ /tmp/flake8_report.txt"
    fi
fi
echo ""

# 2. Black - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (black)..."
if black --check --diff . 2>&1 | grep -q "would reformat"; then
    warning "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–±—É—é—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: black ."
else
    success "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º"
fi
echo ""

# 3. Isort - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ (isort)..."
if isort --check-only --diff . 2>&1 | grep -q "ERROR"; then
    warning "–ò–º–ø–æ—Ä—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: isort ."
else
    success "–ò–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
fi
echo ""

# 4. MyPy - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
echo "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (mypy)..."
if mypy src --ignore-missing-imports --no-strict-optional 2>&1 | grep -q "error"; then
    warning "–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∞–º–∏"
    echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤—ã—à–µ"
else
    success "–¢–∏–ø—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
fi
echo ""

# 5. Pytest - –¢–µ—Å—Ç—ã
echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (pytest)..."
if pytest tests/ -v --tb=short --maxfail=5; then
    success "–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
else
    error "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å!"
    exit 1
fi
echo ""

# 6. Coverage - –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
echo "üìä –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞..."
pytest tests/ --cov=src --cov-report=term --cov-report=html --cov-report=xml -q

COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
    success "–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: ${COVERAGE}% (—Ü–µ–ª—å: 80%)"
else
    warning "–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: ${COVERAGE}% (—Ü–µ–ª—å: 80%)"
    echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Ç–µ—Å—Ç–æ–≤"
fi
echo "HTML –æ—Ç—á—ë—Ç: htmlcov/index.html"
echo ""

# 7. Bandit - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (bandit)..."
if bandit -r src/ -f json -o bandit-report.json -q; then
    success "–ü—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    warning "–ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
    echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ bandit-report.json"
fi
echo ""

# 8. Safety - –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üõ°Ô∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (safety)..."
if safety check --json > safety-report.json 2>&1; then
    success "–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
else
    warning "–ù–∞–π–¥–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö"
    echo "–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ safety-report.json"
fi
echo ""

# –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
echo "================================================"
echo "‚ú® –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê"
echo "================================================"
echo ""
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "  ‚Ä¢ –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: ${COVERAGE}%"
echo "  ‚Ä¢ HTML –æ—Ç—á—ë—Ç: htmlcov/index.html"
echo "  ‚Ä¢ XML –æ—Ç—á—ë—Ç: coverage.xml"
echo ""
echo "–ì–æ—Ç–æ–≤–æ –∫ –∫–æ–º–º–∏—Ç—É! üéâ"
echo ""
